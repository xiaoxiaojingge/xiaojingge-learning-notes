之前我们创建了三个各自独立的数据库实例，mysql-0，mysql-1，mysql-2。
要想让别的容器访问数据库，我们需要将它发布为Service，但是Service带负载均衡功能，每次请求都会转发给不同的数据库，这样子使用过程中会有很大的问题。

## 无头服务（Headless Services）

无头服务（Headless Service）可以为 StatefulSet 成员提供稳定的 DNS 地址。
在不需要负载均衡的情况下，可以通过指定 Cluster IP的值为 "None" 来创建无头服务。

> **注意:**`StatefulSet`中的`ServiceName`必须要跟`Service`中的`metadata.name`一致

```yaml
# 为 StatefulSet 成员提供稳定的 DNS 表项的无头服务（Headless Service）
apiVersion: v1
kind: Service
metadata:
  #重要！这里的名字要跟后面StatefulSet里ServiceName一致
  name: db
  labels:
    app: database
spec:
  ports:
  - name: mysql
    port: 3306
  # 设置Headless Service
  clusterIP: None
  selector:
    app: mysql
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
spec:
  selector:
    matchLabels:
      app: mysql # 必须匹配 .spec.template.metadata.labels
  serviceName: db  #重要！这里的名字要跟Service中metadata.name匹配
  replicas: 3 # 默认值是 1
  minReadySeconds: 10 # 默认值是 0
  template:
    metadata:
      labels:
        app: mysql # 必须匹配 .spec.selector.matchLabels
    spec:
      terminationGracePeriodSeconds: 10
      containers:
        - name: mysql
          image: mysql:5.7
          env:
            - name: MYSQL_ROOT_PASSWORD
              value: "123456"
          ports:
            - containerPort: 3306
          volumeMounts:
            - mountPath: /var/lib/mysql
              name: mysql-data
  volumeClaimTemplates:
    - metadata:
        name: mysql-data
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: local-path
        resources:
          requests:
            storage: 2Gi
```

### 稳定的网络 ID

StatefulSet 中的每个 Pod 都会被分配一个`StatefulSet名称-序号`格式的主机名。<br/>
集群内置的DNS会为`Service`分配一个内部域名`db.default.svc.cluster.local`,它的格式为 `服务名称.命名空间.svc.cluster.local`。<br/>
Service下的每个Pod会被分配一个子域名，格式为`pod名称.所属服务的域名`，例如`mysql-0`的域名为`mysql-0.db.default.svc.cluster.local`。<br/>
创建Pod时，DNS域名生效可能会有一些延迟(几秒或几十秒)。<br/>
Pod之间可以通过DNS域名访问，同一个命名空间下可以省略命名空间及其之后的内容。

```bash
kubectl run dns-test -it --image=busybox:1.28 --rm
# 访问mysql-0数据库
nslookup mysql-0.db
```

参考文档：
[https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/statefulset/](https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/statefulset/)<br/>
[https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/](https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/)<br/>
[https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#headless-services](https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#headless-services)<br/>
[https://kubernetes.io/zh-cn/docs/tasks/run-application/run-replicated-stateful-application/](https://kubernetes.io/zh-cn/docs/tasks/run-application/run-replicated-stateful-application/)<br/>
[https://kubernetes.io/zh-cn/docs/concepts/services-networking/dns-pod-service/](https://kubernetes.io/zh-cn/docs/concepts/services-networking/dns-pod-service/)

