### Pod启动顺序

> 应用部署完成后，当我们重启服务时，如果**ruoyi-admin**在**mysql**或**redis**之前启动，服务会报错，启动失败。

### 初始化容器与启动顺序

我们可以使用初始化容器(Init Container)来控制启动顺序。

- Pod中的初始化容器在应用容器之前启动。
- 初始化容器未执行完成，应用容器不会启动。
- 多个初始化容器按顺序执行，前一个执行完成才会执行下一个。

#### 前端依赖

前端应用`ruoyi-ui`需要等待后端服务`ruoyi-admin`就绪之后再启动。
[初始化容器示例](https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/init-containers/#init-containers-in-use)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ruoyi-ui
  labels:
    app: ruoyi-ui
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ruoyi-ui
  template:
    metadata:
      labels:
        app: ruoyi-ui
    spec:
      initContainers:
        - name: wait-for-ruoyi-admin
          image: nginx:1.22
          command:
            - sh
            - -c
            - |
              until curl -m 3 ruoyi-admin:8080 
              do
                echo waiting for ruoyi-admin;
                sleep 5;
              done
      containers:
        - name: ruoyi-ui
          image: 10.150.36.72:5000/ruoyi-ui:v3.8
          ports:
            - containerPort: 80
          volumeMounts:
            - mountPath: /etc/nginx/conf.d
              name: config
      volumes:
        - name: config
          configMap:
            name: ruoyi-ui-config
            items:
              - key: nginx.conf
                path: default.conf
---
apiVersion: v1
kind: Service
metadata:
  name: ruoyi-ui
spec:
  type: NodePort
  selector:
    app: ruoyi-ui
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30080
```

使用`until do`的方式虽然可以实现等待依赖的服务就绪，但是他是一个无限循环，最好的方式是设置失败重试次数，超过这个次数，初始化容器以失败的状态退出，Pod启动终止。

#### 后端依赖

启动后端应用`ruoyi-admin`需要先确认MySQL和Redis服务已经就绪。
[数据库就绪检查示例](https://github.com/docker-library/docs/blob/master/bonita/stack.yml#L34)

---

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ruoyi-admin
  labels:
    app: ruoyi-admin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ruoyi-admin
  template:
    metadata:
      labels:
        app: ruoyi-admin
    spec:
      initContainers:
        - name: wait-for-mysql
          image: bitnami/mysql:8.0.31-debian-11-r0
          env:
            - name: MYSQL_ROOT_PASSWORD
              value: "123456"
          command:
            - sh
            - -c
            - |
              set -e
              maxTries=10
              while [ "$$maxTries" -gt 0 ] \
                    && ! mysqladmin ping --connect-timeout=3 -s \
                                    -hdb-mysql-primary -uroot -p$$MYSQL_ROOT_PASSWORD
              do 
                  echo 'Waiting for MySQL to be available'
                  sleep 5
                  let maxTries--
              done
              if [ "$$maxTries" -le 0 ]; then
                  echo >&2 'error: unable to contact MySQL after 10 tries'
                  exit 1
              fi
        - name: wait-for-redis
          image: bitnami/redis:7.0.5-debian-11-r7
          env:
            - name: REDIS_PASSWORD
              value: "123456"
          command:
            - sh
            - -c
            - |
              set -e
              maxTries=10
              while [ "$$maxTries" -gt 0 ] \
                    && ! timeout 3 redis-cli -h redis-master -a $$REDIS_PASSWORD ping
              do 
                  echo 'Waiting for Redis to be available'
                  sleep 5
                  let maxTries--
              done
              if [ "$$maxTries" -le 0 ]; then
                  echo >&2 'error: unable to contact Redis after 10 tries'
                  exit 1
              fi
      containers:
        - name: ruoyi-admin
          image: 10.150.36.72:5000/ruoyi-admin:v3.8
          ports:
            - containerPort: 8080
          volumeMounts:
            # springBoot启动时，在jar包所在位置的config目录下查找配置文件
            # jar包所在的位置就是dockerfile中WORKDIR定义的目录，即/app/ruoyi
            - mountPath: /app/ruoyi/config
              name: config
          # 使用application-k8s.yaml作为配置文件
          # 启动命令如下: java -jar ruoyi-admin.jar --spring.profiles.active=k8s
          args: ["--spring.profiles.active=k8s"]
      volumes:
        - name: config
          configMap:
            name: ruoyi-admin-config
---
apiVersion: v1
kind: Service
metadata:
  name: ruoyi-admin
spec:
  type: ClusterIP
  selector:
    app: ruoyi-admin
  ports:
    - port: 8080
      targetPort: 8080
```

参考文档：
[https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/init-containers/#init-containers-in-use](https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/init-containers/#init-containers-in-use)

